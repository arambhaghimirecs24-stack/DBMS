create database employee;
use employee;

CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL DECIMAL(10,2),
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(50),
    PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10,2),
    PRIMARY KEY (EMPNO, INCENTIVE_DATE),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);

INSERT INTO DEPT VALUES
(10, 'HR', 'Bengaluru'),
(20, 'Finance', 'Hyderabad'),
(30, 'IT', 'Mysuru'),
(40, 'Sales', 'Chennai'),
(50, 'Marketing', 'Delhi');

INSERT INTO EMPLOYEE VALUES
(101, 'Amit', 0, '2020-01-10', 50000, 10),
(102, 'Bhavna', 101, '2019-03-15', 60000, 20),
(103, 'Chetan', 101, '2021-06-12', 55000, 30),
(104, 'Deepa', 102, '2018-11-05', 65000, 40),
(105, 'Eshan', 103, '2022-02-19', 48000, 50),
(106, 'Farah', 104, '2021-09-22', 70000, 10);

INSERT INTO PROJECT VALUES
(201, 'Payroll', 'Bengaluru'),
(202, 'BankingApp', 'Hyderabad'),
(203, 'ERPSystem', 'Mysuru'),
(204, 'CRMTool', 'Chennai'),
(205, 'AdCampaign', 'Delhi');

INSERT INTO ASSIGNED_TO VALUES
(101, 201, 'Manager'),
(102, 202, 'Analyst'),
(103, 203, 'Developer'),
(104, 204, 'Sales Rep'),
(105, 205, 'Marketer'),
(106, 201, 'Developer');

INSERT INTO INCENTIVES VALUES
(101, '2023-12-20', 3000),
(103, '2023-11-15', 2000),
(105, '2023-10-10', 2500),
(106, '2023-12-05', 4000),
(104, '2023-09-25', 1500);

SELECT DISTINCT A.EMPNO
FROM ASSIGNED_TO A
JOIN PROJECT P ON A.PNO = P.PNO
WHERE P.PLOC IN ('Bengaluru', 'Hyderabad', 'Mysuru');

SELECT EMPNO
FROM EMPLOYEE
WHERE EMPNO NOT IN (SELECT EMPNO FROM INCENTIVES);

SELECT 
    E.EMPNO, 
    E.ENAME, 
    E.DEPTNO, 
    D.DLOC AS Department_Location, 
    A.JOB_ROLE, 
    P.PLOC AS Project_Location
    
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
JOIN PROJECT P ON A.PNO = P.PNO
WHERE D.DLOC = P.PLOC;

SELECT 
    M.ENAME AS MANAGER_NAME,
    COUNT(E.EMPNO) AS NO_OF_EMPLOYEES
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.ENAME
HAVING COUNT(E.EMPNO) = (
    SELECT MAX(CNT)
    FROM (
        SELECT COUNT(E2.EMPNO) AS CNT
        FROM EMPLOYEE E2
        WHERE E2.MGR_NO <> 0
        GROUP BY E2.MGR_NO
    ) TEMP
);

SELECT DISTINCT M.EMPNO, M.ENAME, M.SAL
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME, M.SAL
HAVING M.SAL > AVG(E.SAL);

SELECT DISTINCT E.ENAME AS SECOND_TOP_MANAGER, D.DNAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE M.MGR_NO = 0; 

SELECT *
FROM EMPLOYEE
WHERE EMPNO = (
    SELECT EMPNO FROM INCENTIVES
    WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
    ORDER BY INCENTIVE_AMOUNT DESC
    LIMIT 1 OFFSET 1
);

SELECT E.EMPNO, E.ENAME, E.DEPTNO, M.ENAME AS MANAGER_NAME, M.DEPTNO AS MANAGER_DEPTNO
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
WHERE E.DEPTNO = M.DEPTNO;

UPDATE EMPLOYEE SET DEPTNO = 10 WHERE EMPNO = 104

